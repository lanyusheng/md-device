# 设备管理系统使用说明

## ✅ 已完成功能

### 1. 登录认证系统
- ✅ 对接真实登录 API (`/Api/DeviceMonitor/User/VerifyUser`)
- ✅ Token 自动管理（localStorage + cookie）
- ✅ 登录状态保持（7天有效期）
- ✅ 路由守卫（未登录自动跳转登录页）
- ✅ 退出登录功能

### 2. 设备管理功能
- ✅ 设备列表展示（分页、排序、搜索）
- ✅ 创建设备
- ✅ 编辑设备
- ✅ 删除设备（单个/批量）
- ✅ 查看设备详情
- ✅ 实时刷新数据

### 3. API 集成
- ✅ 基于原生 fetch 的 HTTP 客户端
- ✅ 统一请求/响应拦截
- ✅ 自动 Token 注入
- ✅ 错误统一处理
- ✅ 超时控制（30秒）

## 📁 项目结构

```
src/
├── types/
│   └── api.ts                    # API 类型定义
├── lib/
│   └── api-client.ts            # HTTP 客户端（fetch 封装）
├── services/
│   ├── auth.service.ts          # 登录认证服务
│   └── device.service.ts        # 设备管理服务
├── features/
│   └── devices/
│       ├── store/
│       │   └── device.store.ts  # Zustand 状态管理
│       └── components/
│           ├── device-listing.tsx
│           ├── device-drawer.tsx
│           └── device-tables/
│               ├── columns.tsx
│               ├── index.tsx
│               ├── cell-action.tsx
│               └── device-toolbar.tsx
└── app/
    ├── login/
    │   └── page.tsx             # 登录页面
    └── dashboard/
        └── devices/
            └── page.tsx         # 设备管理页面
```

## 🚀 快速开始

### 1. 配置环境变量

创建 `.env.local` 文件：

```bash
# API 基础地址
NEXT_PUBLIC_API_BASE_URL=http://你的后端地址/Api/DeviceMonitor
```

### 2. 启动开发服务器

```bash
pnpm dev
```

### 3. 访问系统

- 登录页面: `http://localhost:3000/login`
- 设备管理: `http://localhost:3000/dashboard/devices`

## 🔑 登录流程

1. 访问登录页面
2. 输入用户名和密码
3. 系统调用 `/Api/DeviceMonitor/User/VerifyUser` 接口
4. 登录成功后：
   - Token 保存到 localStorage（key: `auth_token`）
   - Token 同时保存到 cookie（key: `auth-token`）
   - 自动跳转到 Dashboard

## 📊 设备管理功能详解

### 设备列表

- **搜索**: 支持搜索设备ID、设备名称、IP地址
- **排序**: 所有列支持升序/降序排序
- **分页**: 默认每页10条，支持自定义
- **状态指示**:
  - CPU使用率: 绿色(<60%) / 黄色(60-80%) / 红色(>80%)
  - 内存使用率: 绿色(<70%) / 黄色(70-85%) / 红色(>85%)
  - 电量: 绿色(>50%) / 黄色(20-50%) / 红色(<20%)

### 设备操作

#### 创建设备
1. 点击"新建设备"按钮
2. 填写设备信息：
   - 设备名称（必填）
   - CPU核心数（必填）
   - 内存总量（必填）
   - 服务端口（必填，1-65535）
   - 公网IP（可选）
   - 内网IP（可选）
   - 分组ID（可选）
3. 点击"创建设备"

#### 编辑设备
1. 点击设备行的"操作"按钮
2. 选择"编辑"
3. 修改设备信息
4. 点击"更新设备"

#### 查看详情
1. 点击设备行的"操作"按钮
2. 选择"查看详情"
3. 查看完整的设备信息（只读模式）

#### 删除设备

**单个删除**:
1. 点击设备行的"操作"按钮
2. 选择"删除"
3. 确认删除

**批量删除**:
1. 勾选要删除的设备
2. 点击"删除选中"按钮
3. 确认删除

### 刷新数据

点击工具栏的"刷新"按钮可以重新获取最新的设备列表。

## 🔧 API 接口说明

### 登录接口

**接口**: `POST /Api/DeviceMonitor/User/VerifyUser`

**请求示例**:
```json
{
  "UserLocation": {
    "AuthorizationLevel": 0,
    "TenantID": 0,
    "CompanyID": 0,
    ...
  },
  "UserIdentifier": "username",
  "AccessPassword": "password",
  ...
}
```

### 设备管理接口

| 功能 | 方法 | 接口 |
|------|------|------|
| 获取设备列表 | POST | `/Device/GetDevicePage` |
| 创建设备 | POST | `/Device/AddDevice` |
| 更新设备 | POST | `/Device/UpdateDevice` |
| 删除设备 | GET | `/Device/DeleteDevice` |
| 批量删除 | POST | `/Device/BatchRemoveDevice` |

## 🛡️ 安全特性

### Token 管理
- Token 存储在 localStorage 和 cookie 中
- 所有 API 请求自动携带 Token（Authorization: Bearer {token}）
- Token 过期（401）自动跳转登录页

### 路由守卫
- 未登录用户访问 `/dashboard/*` 自动跳转登录页
- 已登录用户访问 `/login` 自动跳转 Dashboard

### 请求拦截
- 统一错误处理
- 请求超时控制（30秒）
- 开发环境请求日志

## 💡 开发提示

### 修改 API 基础地址

编辑 `.env.local`:
```bash
NEXT_PUBLIC_API_BASE_URL=http://新的地址/Api/DeviceMonitor
```

### 修改 Token 有效期

编辑 `src/services/auth.service.ts`:
```typescript
// 修改这一行，单位为秒
document.cookie = `auth-token=${token}; path=/; max-age=${60 * 60 * 24 * 7}`; // 7天
```

### 添加新的设备字段

1. 更新类型定义 `src/types/api.ts`:
```typescript
export interface Device {
  // ... 现有字段
  NewField: string; // 添加新字段
}
```

2. 更新表格列 `src/features/devices/components/device-tables/columns.tsx`

3. 更新表单 `src/features/devices/components/device-drawer.tsx`

### 调试技巧

开发环境下，所有 API 请求会在控制台输出：

```
🚀 API Request: { method: 'POST', url: '...', ... }
✅ API Response: { url: '...', status: 200 }
```

## 🐛 常见问题

### Q: 登录后刷新页面需要重新登录？
A: 检查 cookie 是否正确设置，查看浏览器 Application -> Cookies

### Q: API 请求失败 CORS 错误？
A: 后端需要配置 CORS 允许前端域名访问

### Q: Token 无法保存？
A: 检查后端返回的数据结构，确保包含 token 字段

### Q: 页面空白/报错？
A:
1. 检查 `.env.local` 是否正确配置
2. 检查后端 API 是否可访问
3. 查看浏览器控制台错误信息

## 📝 后续扩展建议

- [ ] 添加设备分组管理
- [ ] 添加设备实时监控大屏
- [ ] 添加设备告警规则
- [ ] 添加操作日志记录
- [ ] 添加数据导出功能
- [ ] 添加投屏功能界面
- [ ] 添加应用管理界面
- [ ] 集成 WebSocket 实时推送

## 📞 技术支持

如有问题，请检查：
1. API 接口文档 `API接口文档.md`
2. 浏览器开发者工具控制台
3. Network 面板查看请求详情
